<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>SULF: FWBuffer.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">FuseWrapper</a></div>
<h1>FWBuffer.h</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/*****************************************************************************</span>
00002 <span class="comment"> * Author:   Valient Gough &lt;vgough@pobox.com&gt;</span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> *****************************************************************************</span>
00005 <span class="comment"> * Copyright (c) 2004, Valient Gough</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * This library is free software; you can distribute it and/or modify it under</span>
00008 <span class="comment"> * the terms of the GNU General Public License (GPL), as published by the Free</span>
00009 <span class="comment"> * Software Foundation; either version 2 of the License, or (at your option)</span>
00010 <span class="comment"> * any later version.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * This library is distributed in the hope that it will be useful, but WITHOUT</span>
00013 <span class="comment"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
00014 <span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GPL in the file COPYING for more</span>
00015 <span class="comment"> * details.</span>
00016 <span class="comment"> */</span>
00017 
00018 <span class="preprocessor">#ifndef _FWBuffer_incl_</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#define _FWBuffer_incl_</span>
00020 <span class="preprocessor"></span>
00021 <span class="preprocessor">#ifndef SWIG</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
00023 <span class="preprocessor">#include &lt;inttypes.h&gt;</span>
00024 <span class="preprocessor">#endif</span>
00025 <span class="preprocessor"></span>
00026 <span class="preprocessor">#ifdef SWIG</span>
00027 <span class="preprocessor"></span><span class="comment">// add BufferWritable interface</span>
00028 %typemap(csinterfaces) struct <a class="code" href="classFWBuffer.html">FWBuffer</a> "IDisposable, <a class="code" href="interfaceBufferWritable.html">BufferWritable</a>"
00029 %typemap(csinterfaces) struct <a class="code" href="classFileBuffer.html">FileBuffer</a> "IDisposable, <a class="code" href="interfaceBufferWritable.html">BufferWritable</a>"
00030 
00031 %apply <span class="keywordtype">int</span> { __s32 };
00032 %apply <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> { __u32 };
00033 <span class="preprocessor">#if __WORDSIZE == 64</span>
00034 <span class="preprocessor"></span>%apply <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> { __u64 };
00035 <span class="preprocessor">#else</span>
00036 <span class="preprocessor"></span>%apply <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> { __u64 };
00037 <span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>
00039 <span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span>
00041 <span class="preprocessor">#ifdef IN_DOXYGEN</span>
00042 <span class="preprocessor"></span><span class="comment">/* This is what the class looks like from C#, so this is how we'll document</span>
00043 <span class="comment"> it..  None of this is real though -- just for Doxygen! */</span>
00044 
00050 <span class="keyword">class </span><a class="code" href="interfaceBufferReadable.html">BufferReadable</a>
00051 {
00052 <span class="keyword">public</span>:
00053     <span class="keywordtype">int</span> copyFrom( <a class="code" href="classFWBuffer.html">FWBuffer</a> buf );
00054 };
00055 
00061 <span class="keyword">class </span><a class="code" href="interfaceBufferWritable.html">BufferWritable</a>
00062 {
00063 <span class="keyword">public</span>:
00064     <span class="keywordtype">int</span> copyTo( <a class="code" href="classFWBuffer.html">FWBuffer</a> buf );
00065 };
00066 
<a name="l00080"></a><a class="code" href="classFWBuffer.html">00080</a> <span class="keyword">class </span><a class="code" href="classFWBuffer.html">FWBuffer</a> : <span class="keyword">public</span> <a class="code" href="interfaceBufferWritable.html">BufferWritable</a>
00081 {
00082 <span class="keyword">public</span>:
00083     <span class="keywordtype">int</span> initialized; 
<a name="l00084"></a><a class="code" href="classFWBuffer.html#o1">00084</a>     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#o1">length</a>;      
<a name="l00085"></a><a class="code" href="classFWBuffer.html#o2">00085</a>     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#o2">offset</a>;      
<a name="l00086"></a><a class="code" href="classFWBuffer.html#o3">00086</a>     <span class="keywordtype">char</span> *<a class="code" href="classFWBuffer.html#o3">data</a>;
00087 
00089     <a class="code" href="classFWBuffer.html#a0">FWBuffer</a>(<span class="keywordtype">int</span> size);
00090     ~<a class="code" href="classFWBuffer.html">FWBuffer</a>();
00092     <span class="keywordtype">void</span> <a class="code" href="classFWBuffer.html#a2">Rewind</a>();
00096     <span class="keywordtype">void</span> <a class="code" href="classFWBuffer.html#a3">Reset</a>();
00099     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a4">EnsureFreeSpace</a>(<span class="keywordtype">int</span> freeBytes);
00103     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a5">Read</a>(<span class="keywordtype">int</span> fd);
00108     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a5">Read</a>(<span class="keywordtype">int</span> fd, size_t count, __u64 <a class="code" href="classFWBuffer.html#o2">offset</a>);
00112     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a7">Write</a>(<span class="keywordtype">int</span> fd, size_t count, __u64 <a class="code" href="classFWBuffer.html#o2">offset</a>);
00116     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a7">Write</a>(<span class="keywordtype">int</span> fd);
00120     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="classFWBuffer.html#a9">GetString</a>();
00121     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a10">GetBytes</a>( <span class="keywordtype">char</span> *<a class="code" href="classFWBuffer.html#o3">data</a>, <span class="keywordtype">int</span> len )
00122     <span class="keywordtype">int</span> GetByte()
00123 
00124     
00125     int AddBytes( const <span class="keywordtype">char</span> *<a class="code" href="classFWBuffer.html#o3">data</a>, <span class="keywordtype">int</span> len );
00128     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a11">AddString</a>(const <span class="keywordtype">char</span> *str);
00131     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a12">AddSubString</a>(const <span class="keywordtype">char</span> *str, <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#o2">offset</a>, <span class="keywordtype">int</span> len);
00133     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a13">AddBuffer</a>( struct <a class="code" href="classFWBuffer.html">FWBuffer</a> *arg );
00137     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a14">copyTo</a>( struct <a class="code" href="classFWBuffer.html">FWBuffer</a> *outBuf );
00138 };
00139 #else
00140 struct <a class="code" href="classFWBuffer.html">FWBuffer</a>
00141 {
00142     <span class="keywordtype">int</span> offset;      <span class="comment">/* current copy offset */</span>
00143 <span class="preprocessor">#  ifdef SWIG</span>
00144 <span class="preprocessor"></span>    %immutable;
00145     %nodefault;
00146 <span class="preprocessor">#  endif</span>
00147 <span class="preprocessor"></span>    <span class="keywordtype">int</span> initialized; <span class="comment">/* number of bytes initialized*/</span>
00148     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#o1">length</a>;      <span class="comment">/* real length of array */</span>
00149     <span class="keywordtype">char</span> *data;
00150 };
00151 <span class="preprocessor">#endif</span>
00152 <span class="preprocessor"></span>
00153 <span class="preprocessor">#ifdef SWIG</span>
00154 <span class="preprocessor"></span>%typemap(csinterfaces) struct <a class="code" href="classFWBuffer.html">FWBuffer</a> "IDisposable, <a class="code" href="interfaceBufferWritable.html">BufferWritable</a>"
00155 
00156 %contract <a class="code" href="classFWBuffer.html">FWBuffer</a>::<a class="code" href="classFWBuffer.html#a5">Read</a>(<span class="keywordtype">int</span> fd) {
00157 require:
00158     fd &gt;= 0;
00159 }
00160 %contract <a class="code" href="classFWBuffer.html#a7">FWBuffer::Write</a>(<span class="keywordtype">int</span> fd) {
00161 require:
00162     fd &gt;= 0;
00163 }
00164 
00165 %extend <a class="code" href="classFWBuffer.html">FWBuffer</a> {
00166     <a class="code" href="classFWBuffer.html">FWBuffer</a>(<span class="keywordtype">int</span> size)
00167     {
00168         <span class="keyword">struct </span><a class="code" href="classFWBuffer.html">FWBuffer</a> *buf = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="classFWBuffer.html">FWBuffer</a>));
00169         buf-&gt;<a class="code" href="classFWBuffer.html#o3">data</a> = malloc(size);
00170         buf-&gt;<a class="code" href="classFWBuffer.html#o0">initialized</a> = 0;
00171         buf-&gt;<a class="code" href="classFWBuffer.html#o1">length</a> = size;
00172         buf-&gt;<a class="code" href="classFWBuffer.html#o2">offset</a> = 0;
00173         <span class="keywordflow">return</span> buf;
00174     }
00175     ~<a class="code" href="classFWBuffer.html">FWBuffer</a>()
00176     {
00177         <span class="keyword">self</span>-&gt;initialized = 0;
00178         <span class="keyword">self</span>-&gt;length = 0;
00179         <span class="keyword">self</span>-&gt;offset = 0;
00180         free(self-&gt;data);
00181         <span class="keyword">self</span>-&gt;data = 0;
00182         free(<span class="keyword">self</span>);
00183         <span class="keyword">self</span> = 0;
00184     }
00185 
00186     <span class="keywordtype">void</span> <a class="code" href="classFWBuffer.html#a2">Rewind</a>()
00187     {
00188         <span class="keyword">self</span>-&gt;offset = 0;
00189     }
00190 
00191     <span class="keywordtype">void</span> <a class="code" href="classFWBuffer.html#a3">Reset</a>()
00192     {
00193         <span class="keyword">self</span>-&gt;initialized = 0;
00194         <span class="keyword">self</span>-&gt;offset = 0;
00195         memset(self-&gt;data, 0, self-&gt;length);
00196     }
00197     
00198     <span class="comment">/* ensure the given amount of free space */</span>
00199     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a4">EnsureFreeSpace</a>(<span class="keywordtype">int</span> freeBytes)
00200     {
00201         <span class="keywordflow">if</span>( freeBytes + <span class="keyword">self</span>-&gt;offset &gt; <span class="keyword">self</span>-&gt;length )
00202         {
00203             <span class="keywordtype">int</span> newSize = 2 * <span class="keyword">self</span>-&gt;length;
00204             <span class="keywordtype">void</span> *ptr;
00205             <span class="keywordflow">if</span>(freeBytes + <span class="keyword">self</span>-&gt;offset &gt; newSize)
00206                 newSize = freeBytes + <span class="keyword">self</span>-&gt;offset;
00207             ptr = realloc( self-&gt;data, newSize );
00208             <span class="keywordflow">if</span>(ptr == NULL)
00209                 <span class="keywordflow">return</span> -ENOMEM;
00210             <span class="keyword">self</span>-&gt;data = ptr;
00211             <span class="keyword">self</span>-&gt;length = newSize;
00212         }
00213 
00214         <span class="keywordflow">return</span> 0;
00215     }
00216 
00217 
00218     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a5">Read</a>(<span class="keywordtype">int</span> fd)
00219     {
00220         <span class="keywordtype">int</span> result = read( fd, self-&gt;data + self-&gt;offset, 
00221                 self-&gt;length - self-&gt;offset );
00222         <span class="keywordflow">if</span>(result &lt; 0)
00223             result = -errno;
00224         <span class="keywordflow">else</span>
00225             <span class="keyword">self</span>-&gt;initialized += result;
00226 
00227         <span class="keywordflow">return</span> result;
00228     }
00229     
00230     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a5">Read</a>(<span class="keywordtype">int</span> fd, size_t count, __u64 <a class="code" href="classFWBuffer.html#o2">offset</a>)
00231     {
00232         <span class="keywordtype">int</span> result;
00233         FWBuffer_EnsureFreeSpace( <span class="keyword">self</span>, count );
00234         result = pread( fd, self-&gt;data + self-&gt;offset, count, offset );
00235         <span class="keywordflow">if</span>(result &lt; 0)
00236             result = -errno;
00237         <span class="keywordflow">else</span>
00238             <span class="keyword">self</span>-&gt;initialized += result;
00239 
00240         <span class="keywordflow">return</span> result;
00241     }
00242     
00243     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a7">Write</a>(<span class="keywordtype">int</span> fd, size_t count, __u64 <a class="code" href="classFWBuffer.html#o2">offset</a>)
00244     {
00245         <span class="keywordtype">int</span> result;
00246         <span class="keywordflow">if</span>(<span class="keyword">self</span>-&gt;offset + count &gt; <span class="keyword">self</span>-&gt;initialized)
00247             <span class="keywordflow">return</span> -EIO;
00248 
00249         result = pwrite( fd, self-&gt;data + self-&gt;offset, count, offset );
00250         <span class="keywordflow">if</span>(result &lt; 0)
00251             result = -errno;
00252         <span class="keywordflow">else</span>
00253             <span class="keyword">self</span>-&gt;offset += result;
00254 
00255         <span class="keywordflow">return</span> result;
00256     }
00257 
00258     <span class="comment">/*</span>
00259 <span class="comment">        Write from the start of the buffer, every initialized byte.</span>
00260 <span class="comment">    */</span>
00261     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a7">Write</a>(<span class="keywordtype">int</span> fd)
00262     {
00263         <span class="keywordtype">int</span> result = write( fd, self-&gt;data + self-&gt;offset, 
00264                 self-&gt;initialized - self-&gt;offset );
00265         <span class="keywordflow">if</span>(result &lt; 0)
00266             result = -errno;
00267         <span class="keywordflow">else</span>
00268             <span class="keyword">self</span>-&gt;offset += result;
00269 
00270         <span class="keywordflow">return</span> result;
00271     }
00272 
00273     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="classFWBuffer.html#a9">GetString</a>()
00274     {
00275         <span class="keyword">const</span> <span class="keywordtype">char</span> *result = (<span class="keywordtype">char</span>*)<span class="keyword">self</span>-&gt;data + <span class="keyword">self</span>-&gt;offset;
00276         <span class="keywordtype">int</span> len = strlen(result);
00277         <span class="keywordflow">if</span>(len + <span class="keyword">self</span>-&gt;offset &gt; <span class="keyword">self</span>-&gt;initialized )
00278             <span class="keywordflow">return</span> NULL;
00279         <span class="keywordflow">else</span>
00280         {
00281             <span class="keyword">self</span>-&gt;offset += len + 1;
00282             <span class="keywordflow">return</span> strdup(result);
00283         }
00284     }
00285 
00286     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a10">GetBytes</a>( <span class="keywordtype">char</span> *<a class="code" href="classFWBuffer.html#o3">data</a>, <span class="keywordtype">int</span> len )
00287     {
00288         <span class="keywordflow">if</span>( <span class="keyword">self</span>-&gt;initialized - <span class="keyword">self</span>-&gt;offset &gt;= len )
00289         {
00290             memcpy( data, self-&gt;data + self-&gt;offset, len );
00291             <span class="keyword">self</span>-&gt;offset += len;
00292             <span class="keywordflow">return</span> len;
00293         } <span class="keywordflow">else</span>
00294             <span class="keywordflow">return</span> -1;
00295     }
00296     
00297     <span class="keywordtype">int</span> GetByte()
00298     {
00299         <span class="keywordflow">if</span>( <span class="keyword">self</span>-&gt;initialized &gt; <span class="keyword">self</span>-&gt;offset )
00300         {
00301             <span class="keywordtype">int</span> res = (int)*((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<span class="keyword">self</span>-&gt;data + <span class="keyword">self</span>-&gt;offset);
00302             ++<span class="keyword">self</span>-&gt;offset;
00303             <span class="keywordflow">return</span> res;
00304         } <span class="keywordflow">else</span>
00305             <span class="keywordflow">return</span> -1;
00306     }
00307 
00308     <span class="keywordtype">int</span> AddBytes( <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="classFWBuffer.html#o3">data</a>, <span class="keywordtype">int</span> len )
00309     {
00310         <span class="keywordtype">int</span> res = FWBuffer_EnsureFreeSpace( <span class="keyword">self</span>, len );
00311         <span class="keywordflow">if</span>(res == 0)
00312         {
00313             memcpy( self-&gt;data + self-&gt;offset, data, len );
00314             <span class="keyword">self</span>-&gt;offset += len;
00315             <span class="keywordflow">if</span>(<span class="keyword">self</span>-&gt;initialized &lt; <span class="keyword">self</span>-&gt;offset)
00316                 <span class="keyword">self</span>-&gt;initialized = <span class="keyword">self</span>-&gt;offset;
00317             res = len;
00318         }
00319         <span class="keywordflow">return</span> res;
00320     }
00321     
00322     <span class="keywordtype">int</span> AddChar( <span class="keywordtype">int</span> len, <span class="keywordtype">char</span> value )
00323     {
00324         <span class="keywordtype">int</span> res = FWBuffer_EnsureFreeSpace( <span class="keyword">self</span>, len );
00325         <span class="keywordflow">if</span>(res == 0)
00326         {
00327             memset( self-&gt;data + self-&gt;offset, value, len );
00328             <span class="keyword">self</span>-&gt;offset += len;
00329             <span class="keywordflow">if</span>(<span class="keyword">self</span>-&gt;initialized &lt; <span class="keyword">self</span>-&gt;offset)
00330                 <span class="keyword">self</span>-&gt;initialized = <span class="keyword">self</span>-&gt;offset;
00331         }
00332         <span class="keywordflow">return</span> res;
00333     }
00334 
00335     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a11">AddString</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str)
00336     {
00337         <span class="keywordtype">int</span> len = strlen( str ) + 1;
00338         <span class="keywordflow">return</span> FWBuffer_AddBytes( <span class="keyword">self</span>, str, len );
00339     }
00340     
00341     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a12">AddSubString</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#o2">offset</a>, <span class="keywordtype">int</span> len)
00342     {
00343         <span class="keywordflow">return</span> FWBuffer_AddBytes( <span class="keyword">self</span>, str+offset, len );
00344     }
00345 
00346     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a13">AddBuffer</a>( <span class="keyword">struct</span> <a class="code" href="classFWBuffer.html">FWBuffer</a> *arg )
00347     {
00348         <span class="keywordflow">return</span> FWBuffer_AddBytes( <span class="keyword">self</span>, 
00349                 arg-&gt;<a class="code" href="classFWBuffer.html#o3">data</a> + arg-&gt;<a class="code" href="classFWBuffer.html#o2">offset</a>, arg-&gt;<a class="code" href="classFWBuffer.html#o0">initialized</a> - arg-&gt;<a class="code" href="classFWBuffer.html#o2">offset</a>);
00350     }
00351 
00352     <span class="comment">/* methods for BufferWritable interface */</span>
00353     <span class="keywordtype">int</span> <a class="code" href="classFWBuffer.html#a14">copyTo</a>( <span class="keyword">struct</span> <a class="code" href="classFWBuffer.html">FWBuffer</a> *outBuf )
00354     {
00355         <span class="keywordflow">return</span> FWBuffer_AddBytes( outBuf, 
00356                 self-&gt;<a class="code" href="classFWBuffer.html#o3">data</a> + self-&gt;offset, self-&gt;initialized - self-&gt;offset);
00357     }
00358 }
00359 <span class="preprocessor">#endif</span>
00360 <span class="preprocessor"></span>
00361 
00362 <span class="preprocessor">#ifdef IN_DOXYGEN</span>
00363 <span class="preprocessor"></span><span class="comment">/* This is what the class looks like from C#, so this is how we'll document</span>
00364 <span class="comment"> it..  None of this is real though -- just for Doxygen! */</span>
<a name="l00372"></a><a class="code" href="classFileBuffer.html">00372</a> <span class="keyword">class </span><a class="code" href="classFileBuffer.html">FileBuffer</a> : <span class="keyword">public</span> <a class="code" href="interfaceBufferWritable.html">BufferWritable</a>
00373 {
00374 <span class="keyword">public</span>:
00375     <a class="code" href="classFileBuffer.html">FileBuffer</a>();
00376     ~<a class="code" href="classFileBuffer.html">FileBuffer</a>();
00377 
00380     <span class="keywordtype">int</span> <a class="code" href="classFileBuffer.html#a2">addFile</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> *name, __u64 nodeId, __u32 type, __u64 off );
00381 
00382     <span class="keywordtype">int</span> copyTo( <span class="keyword">struct</span> <a class="code" href="classFWBuffer.html">FWBuffer</a> *outBuf );
00383 
00384     <span class="comment">// set to point to a buffer before using..</span>
00385     <a class="code" href="classFWBuffer.html">FWBuffer</a> *buf;
00386     <span class="keywordtype">int</span> error;
00387 };
00388 <span class="preprocessor">#else</span>
00389 <span class="preprocessor"></span><span class="keyword">struct </span><a class="code" href="classFileBuffer.html">FileBuffer</a>
00390 {
00391 <span class="preprocessor">#  ifdef SWIG</span>
00392 <span class="preprocessor"></span>    %immutable;
00393     %nodefault;
00394 <span class="preprocessor">#  endif</span>
00395 <span class="preprocessor"></span>    <span class="keyword">struct </span><a class="code" href="classFWBuffer.html">FWBuffer</a> *buf;
00396     <span class="keywordtype">int</span> error;
00397 };
00398 <span class="preprocessor">#endif</span>
00399 <span class="preprocessor"></span>
00400 <span class="preprocessor">#ifdef SWIG</span>
00401 <span class="preprocessor"></span>%extend <a class="code" href="classFileBuffer.html">FileBuffer</a> {
00402     <a class="code" href="classFileBuffer.html">FileBuffer</a>( <span class="keyword">struct</span> <a class="code" href="classFWBuffer.html">FWBuffer</a> *buffer )
00403     {
00404         <span class="keyword">struct </span><a class="code" href="classFileBuffer.html">FileBuffer</a> *buf = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="classFileBuffer.html">FileBuffer</a>));
00405         buf-&gt;<a class="code" href="classFileBuffer.html#o0">buf</a> = buffer;
00406         buf-&gt;<a class="code" href="classFileBuffer.html#o1">error</a> = 0;
00407         <span class="keywordflow">return</span> buf;
00408     }
00409     ~<a class="code" href="classFileBuffer.html">FileBuffer</a>()
00410     {
00411         free( <span class="keyword">self</span> );
00412     }
00413     <span class="keywordtype">int</span> <a class="code" href="classFileBuffer.html#a2">addFile</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> *name, __u64 nodeId, __u32 type, __u64 off )
00414     {
00415         <span class="comment">// make sure buffer has enough space</span>
00416         <span class="keywordtype">unsigned</span> namelen = strlen( name );
00417         <span class="keywordtype">unsigned</span> entlen;
00418         <span class="keywordtype">unsigned</span> entsize;
00419         <span class="keywordtype">unsigned</span> newlen;
00420         <span class="keywordtype">unsigned</span> padlen;
00421         <span class="keyword">struct </span>fuse_dirent dirent;
00422 
00423         <span class="keywordflow">if</span>(namelen &gt; FUSE_NAME_MAX)
00424             namelen = FUSE_NAME_MAX;
00425         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!namelen)
00426         {
00427             <span class="keyword">self</span>-&gt;error = -EIO;
00428             <span class="keywordflow">return</span> 1;
00429         }
00430 
00431         entlen = FUSE_NAME_OFFSET + namelen;
00432         entsize = FUSE_DIRENT_ALIGN( entlen );
00433         padlen = entsize - entlen;
00434         newlen = <span class="keyword">self</span>-&gt;buf-&gt;offset + entsize;
00435         <span class="comment">//if(off &amp;&amp; newlen &gt; self-&gt;reqLen ) return 1;</span>
00436 
00437         <span class="comment">// TODO: allow inode number passthru</span>
00438         dirent.ino = -1;
00439         dirent.off = off ? off : newlen;
00440         dirent.namelen = namelen;
00441         dirent.type = type;
00442 
00443         FWBuffer_AddBytes( self-&gt;buf, (<span class="keywordtype">char</span>*)&amp;dirent, 
00444                 <span class="keyword">sizeof</span>(<span class="keyword">struct</span> fuse_dirent));
00445         FWBuffer_AddBytes( self-&gt;buf, name, namelen );
00446         <span class="keywordflow">if</span>(padlen)
00447             FWBuffer_AddChar( self-&gt;buf, padlen, <span class="charliteral">'\0'</span> );
00448 
00449         <span class="keywordflow">return</span> 0;
00450     }
00451     
00452     <span class="keywordtype">int</span> copyTo( <span class="keyword">struct</span> <a class="code" href="classFWBuffer.html">FWBuffer</a> *outBuf )
00453     {
00454         <span class="keywordtype">int</span> res;
00455         <span class="keywordtype">int</span> off = <span class="keyword">self</span>-&gt;buf-&gt;offset;
00456         FWBuffer_Rewind( self-&gt;buf );
00457         res = FWBuffer_copyTo( self-&gt;buf, outBuf );
00458         <span class="keyword">self</span>-&gt;buf-&gt;offset = off;
00459         <span class="keywordflow">return</span> res;
00460     }
00461 }
00462 <span class="preprocessor">#endif </span><span class="comment">/* SWIG */</span>
00463 
00464 
00465 <span class="preprocessor">#endif</span>
00466 <span class="preprocessor"></span>
00467 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Apr 29 22:42:10 2005 for SULF by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.2 </small></address>
</body>
</html>
